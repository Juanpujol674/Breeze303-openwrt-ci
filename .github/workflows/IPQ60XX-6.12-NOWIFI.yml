name: IPQ60XX-6.12-NOWIFI

on:
  workflow_dispatch:
  schedule:
    - cron: "0 18 * * *"  # UTCæ—¶é—´18:00ï¼ˆåŒ—äº¬æ—¶é—´å‡Œæ™¨2ç‚¹ï¼‰

jobs:
  Build:
    runs-on: ubuntu-22.04
    env:
      REPO_URL: https://github.com/LiBwrt/openwrt-6.x.git
      REPO_BRANCH: kernel-6.12
      CONFIG_FILE: configs/ipq60xx-6.12-nowifi.config
      DIY_SCRIPT: diy-script.sh
      CLASH_KERNEL: amd64
      CACHE_TOOLCHAIN: true
      UPLOAD_BIN_DIR: false
      FIRMWARE_RELEASE: true
      FIRMWARE_TAG: IPQ60XX-6.12-NOWIFI
      TZ: Asia/Shanghai

    steps:
      - name: Check Server Performance(æ£€æŸ¥æœåŠ¡å™¨æ€§èƒ½)
        run: |
          echo "::group::ğŸ–¥ï¸ æœåŠ¡å™¨æ€§èƒ½æ£€æŸ¥"
          echo "è­¦å‘Šï¼šåˆ†é…çš„æœåŠ¡å™¨èµ„æºå¯èƒ½å—é™ï¼Œå»ºè®®æ§åˆ¶æ’ä»¶æ•°é‡ï¼"
          echo "CPUå‹å·ï¼š$(lscpu | grep 'Model name' | cut -d: -f2 | sed 's/^ *//')"
          echo "CPUæ ¸å¿ƒæ•°ï¼š$(nproc)"
          echo "å†…å­˜æ€»é‡ï¼š$(free -h | awk '/Mem/{print $2}')"
          echo "å­˜å‚¨ç©ºé—´ï¼š"
          df -hT
          echo "::endgroup::"

      - name: Initialization Environment(åˆå§‹åŒ–ç¯å¢ƒ)
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          echo "::group::ğŸ§¹ ç¯å¢ƒåˆå§‹åŒ–"
          sudo rm -rf /usr/share/dotnet /etc/apt/sources.list.d/* || true
          sudo apt-get -qq update
          sudo apt-get -qq install $(curl -fsSL is.gd/depends_ubuntu_2204)
          sudo timedatectl set-timezone "$TZ"
          echo "::endgroup::"

      - name: Combine Disks(åˆå¹¶ç£ç›˜)
        uses: easimon/maximize-build-space@master
        with:
          swap-size-mb: 1024
          root-reserve-mb: 1024

      - name: Checkout
        uses: actions/checkout@v4

      - name: Clone Source Code(å…‹éš†æºä»£ç )
        env:
          REPO_BRANCH: ${{ env.REPO_BRANCH }}
          REPO_URL: ${{ env.REPO_URL }}
        run: |
          echo "::group::ğŸ“¦ å…‹éš†æºä»£ç "
          # å˜é‡éªŒè¯
          echo "â–¼â–¼â–¼ ç¯å¢ƒéªŒè¯ â–¼â–¼â–¼"
          echo "ä»“åº“åˆ†æ”¯ï¼š'$REPO_BRANCH'"
          echo "ä»“åº“åœ°å€ï¼š'$REPO_URL'"

          # åˆ†æ”¯å­˜åœ¨æ€§æ£€æŸ¥
          if ! git ls-remote --exit-code --heads "$REPO_URL" "$REPO_BRANCH"; then
            echo "::error::åˆ†æ”¯ $REPO_BRANCH ä¸å­˜åœ¨ï¼"
            git ls-remote --heads "$REPO_URL" | awk -F'/' '{print $3}'
            exit 1
          fi

          # æ‰§è¡Œå…‹éš†
          set -x
          git clone --progress --depth 1 -b "${REPO_BRANCH}" "${REPO_URL}" openwrt
          set +x

          # ä»“åº“éªŒè¯
          echo "â–¼â–¼â–¼ ä»“åº“éªŒè¯ â–¼â–¼â–¼"
          cd openwrt && git log -1 --pretty='%h - %s (%an)'
          echo "OPENWRT_PATH=$(pwd)" >> $GITHUB_ENV
          echo "::endgroup::"

      - name: Generate Variables(ç”Ÿæˆå˜é‡)
        run: |
          echo "::group::âš™ï¸ ç”Ÿæˆæ„å»ºå˜é‡"
          cp -v "$CONFIG_FILE" "$OPENWRT_PATH/.config"
          cd "$OPENWRT_PATH" && make defconfig

          echo "DEVICE_TARGET=$(awk -F'"' '/CONFIG_TARGET_BOARD/{print $2}' .config)" >> $GITHUB_ENV
          echo "DEVICE_SUBTARGET=$(awk -F'"' '/CONFIG_TARGET_SUBTARGET/{print $2}' .config)" >> $GITHUB_ENV
          echo "::endgroup::"

      - name: Cache Toolchain(ç¼“å­˜å·¥å…·é“¾)
        if: env.CACHE_TOOLCHAIN == 'true'
        uses: actions/cache@v3
        with:
          path: |
            ${{ env.OPENWRT_PATH }}/dl
            ${{ env.OPENWRT_PATH }}/build_dir
          key: ${{ runner.os }}-${{ env.DEVICE_TARGET }}-${{ hashFiles('${{ env.OPENWRT_PATH }}/.config') }}

      - name: Install Feeds(å®‰è£…feeds)
        run: |
          echo "::group::ğŸ“¦ å®‰è£…è½¯ä»¶æº"
          cd "$OPENWRT_PATH"
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          echo "::endgroup::"

      - name: Load Custom Configuration(åŠ è½½è‡ªå®šä¹‰é…ç½®)
        run: |
          echo "::group::ğŸ“ è¿ç§»è‡ªå®šä¹‰æ–‡ä»¶"
          if [ -d "files" ]; then
            rsync -av --checksum files/ "$OPENWRT_PATH/files/"
            echo "è¿ç§»æ–‡ä»¶æ•°ï¼š$(find "$OPENWRT_PATH/files" -type f | wc -l)"
          else
            echo "æœªæ£€æµ‹åˆ°è‡ªå®šä¹‰æ–‡ä»¶ç›®å½•"
          fi
          echo "::endgroup::"

          echo "::group::ğŸ› ï¸ æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬"
          script_path="$GITHUB_WORKSPACE/$DIY_SCRIPT"
          chmod +x "$script_path"
          
          cd "$OPENWRT_PATH"
          set -ex
          /usr/bin/time -v bash -e "$script_path"
          echo "::endgroup::"

          echo "::group::âœ… é…ç½®æœ€ç»ˆæ£€æŸ¥"
          grep -E 'CONFIG_TARGET|CONFIG_PACKAGE' .config | sort
          echo "::endgroup::"

      - name: Download DL Package(ä¸‹è½½DLè½¯ä»¶åŒ…)
        run: |
          echo "::group::ğŸ“¥ ä¸‹è½½ä¾èµ–åŒ…"
          cd "$OPENWRT_PATH"
          make -j8 download
          find dl -size -1k -delete
          echo "å‰©ä½™dlåŒ…æ•°é‡ï¼š$(find dl -type f | wc -l)"
          echo "::endgroup::"

      - name: Compile Firmware(ç¼–è¯‘å›ºä»¶)
        timeout-minutes: 120
        run: |
          echo "::group::ğŸ”¥ å¼€å§‹ç¼–è¯‘"
          cd "$OPENWRT_PATH"
          echo "ä½¿ç”¨çº¿ç¨‹æ•°ï¼š$(($(nproc)+1))"
          make -j$(($(nproc)+1)) || make -j1 V=s
          echo "status=success" >> $GITHUB_OUTPUT
          echo "DATE=$(date +'%Y-%m-%d')" >> $GITHUB_ENV
          echo "::endgroup::"

      - name: Organize Files(æ•´ç†æ–‡ä»¶)
        if: success()
        run: |
          echo "::group::ğŸ“¦ æ•´ç†æ„å»ºæˆæœ"
          cd "$OPENWRT_PATH/bin/targets"/*/*
          cp "$OPENWRT_PATH/.config" build.config
          mkdir -p packages && mv ../packages/*/*.ipk packages/ || true
          tar -zcf Packages.tar.gz packages
          echo "FIRMWARE_PATH=$PWD" >> $GITHUB_ENV
          echo "::endgroup::"

      - name: Upload Firmware To Artifact(ä¸Šä¼ æµ‹è¯•ç‰ˆ)
        if: env.FIRMWARE_RELEASE != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.FIRMWARE_TAG }}-${{ env.DEVICE_TARGET }}-${{ env.DATE }}
          path: ${{ env.FIRMWARE_PATH }}

      - name: Upload Firmware To Release(å‘å¸ƒæ­£å¼ç‰ˆ)
        if: env.FIRMWARE_RELEASE == 'true'
        uses: softprops/action-gh-release@v2  # å»ºè®®å‡çº§åˆ°v2ç‰ˆæœ¬
        with:
          name: R${{ env.DATE }} for ${{ env.FIRMWARE_TAG }}
          allowUpdates: false
          tag: ${{ env.FIRMWARE_TAG }}-${{ env.FILE_DATE }}
          token: ${{ secrets.GITHUB_TOKEN }}
          artifacts: ${{ env.FIRMWARE_PATH }}/*
          files: |
            ${{ env.FIRMWARE_PATH }}/*.bin
            ${{ env.FIRMWARE_PATH }}/Packages.tar.gz
            ${{ env.FIRMWARE_PATH }}/build.config
          body: |
            **This is OpenWrt Firmware for ${{ env.FIRMWARE_TAG }}**
            ### ğŸ“’ å›ºä»¶ä¿¡æ¯(æ— WIFI)
            - ğŸš€ å†…æ ¸ç‰ˆæœ¬ï¼š${{ env.VERSION_KERNEL }}
            - ğŸ“… ç¼–è¯‘æ—¥æœŸï¼š${{ env.DATE }}
            - ğŸ–¥ï¸ ç›®æ ‡å¹³å°ï¼š${{ env.DEVICE_TARGET }} (${{ env.DEVICE_SUBTARGET }})
            - ğŸ“ æºç ä»“åº“ï¼š[${{ env.REPO_BRANCH }}åˆ†æ”¯](${{ env.REPO_URL }}/tree/${{ env.REPO_BRANCH }})
            
            ### ğŸ”§ é»˜è®¤é…ç½®
            - ğŸŒ ç®¡ç†åœ°å€ï¼š192.168.1.1
            - ğŸ”‘ ç®¡ç†å‘˜å¯†ç ï¼špassword
            - ğŸ“¦ åŒ…å«è½¯ä»¶åŒ…ï¼š$(zcat ${{ env.FIRMWARE_PATH }}/Packages.tar.gz | grep Package: | wc -l)ä¸ª
            
            ### ğŸ“‹ ç‰ˆæœ¬è®°å½•
            ${{ env.VERSION_INFO }}

            > æ ¡éªŒä¿¡æ¯ï¼š$(sha256sum ${{ env.FIRMWARE_PATH }}/*.bin | awk '{print $1}')
