name: IPQ60XX-6.12-NOWIFI

on:
  workflow_dispatch:
  schedule:
    - cron: "0 18 * * *"  # UTC时间18:00（北京时间凌晨2点）

jobs:
  Build:
    runs-on: ubuntu-22.04
    env:
      REPO_URL: https://github.com/LiBwrt/openwrt-6.x.git
      REPO_BRANCH: kernel-6.12
      CONFIG_FILE: configs/ipq60xx-6.12-nowifi.config
      DIY_SCRIPT: diy-script.sh
      CLASH_KERNEL: amd64
      CACHE_TOOLCHAIN: true
      UPLOAD_BIN_DIR: false
      FIRMWARE_RELEASE: true
      FIRMWARE_TAG: IPQ60XX-6.12-NOWIFI
      TZ: Asia/Shanghai

    steps:
      - name: Check Server Performance(检查服务器性能)
        run: |
          echo "::group::🖥️ 服务器性能检查"
          echo "警告：分配的服务器资源可能受限，建议控制插件数量！"
          echo "CPU型号：$(lscpu | grep 'Model name' | cut -d: -f2 | sed 's/^ *//')"
          echo "CPU核心数：$(nproc)"
          echo "内存总量：$(free -h | awk '/Mem/{print $2}')"
          echo "存储空间："
          df -hT
          echo "::endgroup::"

      - name: Initialization Environment(初始化环境)
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          echo "::group::🧹 环境初始化"
          sudo rm -rf /usr/share/dotnet /etc/apt/sources.list.d/* || true
          sudo apt-get -qq update
          sudo apt-get -qq install $(curl -fsSL is.gd/depends_ubuntu_2204)
          sudo timedatectl set-timezone "$TZ"
          echo "::endgroup::"

      - name: Combine Disks(合并磁盘)
        uses: easimon/maximize-build-space@master
        with:
          swap-size-mb: 1024
          root-reserve-mb: 1024

      - name: Checkout
        uses: actions/checkout@v4

      - name: Clone Source Code(克隆源代码)
        env:
          REPO_BRANCH: ${{ env.REPO_BRANCH }}
          REPO_URL: ${{ env.REPO_URL }}
        run: |
          echo "::group::📦 克隆源代码"
          # 变量验证
          echo "▼▼▼ 环境验证 ▼▼▼"
          echo "仓库分支：'$REPO_BRANCH'"
          echo "仓库地址：'$REPO_URL'"

          # 分支存在性检查
          if ! git ls-remote --exit-code --heads "$REPO_URL" "$REPO_BRANCH"; then
            echo "::error::分支 $REPO_BRANCH 不存在！"
            git ls-remote --heads "$REPO_URL" | awk -F'/' '{print $3}'
            exit 1
          fi

          # 执行克隆
          set -x
          git clone --progress --depth 1 -b "${REPO_BRANCH}" "${REPO_URL}" openwrt
          set +x

          # 仓库验证
          echo "▼▼▼ 仓库验证 ▼▼▼"
          cd openwrt && git log -1 --pretty='%h - %s (%an)'
          echo "OPENWRT_PATH=$(pwd)" >> $GITHUB_ENV
          echo "::endgroup::"

      - name: Generate Variables(生成变量)
        run: |
          echo "::group::⚙️ 生成构建变量"
          cp -v "$CONFIG_FILE" "$OPENWRT_PATH/.config"
          cd "$OPENWRT_PATH" && make defconfig

          echo "DEVICE_TARGET=$(awk -F'"' '/CONFIG_TARGET_BOARD/{print $2}' .config)" >> $GITHUB_ENV
          echo "DEVICE_SUBTARGET=$(awk -F'"' '/CONFIG_TARGET_SUBTARGET/{print $2}' .config)" >> $GITHUB_ENV
          echo "::endgroup::"

      - name: Cache Toolchain(缓存工具链)
        if: env.CACHE_TOOLCHAIN == 'true'
        uses: actions/cache@v3
        with:
          path: |
            ${{ env.OPENWRT_PATH }}/dl
            ${{ env.OPENWRT_PATH }}/build_dir
          key: ${{ runner.os }}-${{ env.DEVICE_TARGET }}-${{ hashFiles('${{ env.OPENWRT_PATH }}/.config') }}

      - name: Install Feeds(安装feeds)
        run: |
          echo "::group::📦 安装软件源"
          cd "$OPENWRT_PATH"
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          echo "::endgroup::"

      - name: Load Custom Configuration(加载自定义配置)
        run: |
          echo "::group::📁 迁移自定义文件"
          if [ -d "files" ]; then
            rsync -av --checksum files/ "$OPENWRT_PATH/files/"
            echo "迁移文件数：$(find "$OPENWRT_PATH/files" -type f | wc -l)"
          else
            echo "未检测到自定义文件目录"
          fi
          echo "::endgroup::"

          echo "::group::🛠️ 执行自定义脚本"
          script_path="$GITHUB_WORKSPACE/$DIY_SCRIPT"
          chmod +x "$script_path"
          
          cd "$OPENWRT_PATH"
          set -ex
          /usr/bin/time -v bash -e "$script_path"
          echo "::endgroup::"

          echo "::group::✅ 配置最终检查"
          grep -E 'CONFIG_TARGET|CONFIG_PACKAGE' .config | sort
          echo "::endgroup::"

      - name: Download DL Package(下载DL软件包)
        run: |
          echo "::group::📥 下载依赖包"
          cd "$OPENWRT_PATH"
          make -j8 download
          find dl -size -1k -delete
          echo "剩余dl包数量：$(find dl -type f | wc -l)"
          echo "::endgroup::"

      - name: Compile Firmware(编译固件)
        timeout-minutes: 120
        run: |
          echo "::group::🔥 开始编译"
          cd "$OPENWRT_PATH"
          echo "使用线程数：$(($(nproc)+1))"
          make -j$(($(nproc)+1)) || make -j1 V=s
          echo "status=success" >> $GITHUB_OUTPUT
          echo "DATE=$(date +'%Y-%m-%d')" >> $GITHUB_ENV
          echo "::endgroup::"

      - name: Organize Files(整理文件)
        if: success()
        run: |
          echo "::group::📦 整理构建成果"
          cd "$OPENWRT_PATH/bin/targets"/*/*
          cp "$OPENWRT_PATH/.config" build.config
          mkdir -p packages && mv ../packages/*/*.ipk packages/ || true
          tar -zcf Packages.tar.gz packages
          echo "FIRMWARE_PATH=$PWD" >> $GITHUB_ENV
          echo "::endgroup::"

      - name: Upload Firmware To Artifact(上传测试版)
        if: env.FIRMWARE_RELEASE != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.FIRMWARE_TAG }}-${{ env.DEVICE_TARGET }}-${{ env.DATE }}
          path: ${{ env.FIRMWARE_PATH }}

      - name: Upload Firmware To Release(发布正式版)
        if: env.FIRMWARE_RELEASE == 'true'
        uses: softprops/action-gh-release@v2  # 建议升级到v2版本
        with:
          name: R${{ env.DATE }} for ${{ env.FIRMWARE_TAG }}
          allowUpdates: false
          tag: ${{ env.FIRMWARE_TAG }}-${{ env.FILE_DATE }}
          token: ${{ secrets.GITHUB_TOKEN }}
          artifacts: ${{ env.FIRMWARE_PATH }}/*
          files: |
            ${{ env.FIRMWARE_PATH }}/*.bin
            ${{ env.FIRMWARE_PATH }}/Packages.tar.gz
            ${{ env.FIRMWARE_PATH }}/build.config
          body: |
            **This is OpenWrt Firmware for ${{ env.FIRMWARE_TAG }}**
            ### 📒 固件信息(无WIFI)
            - 🚀 内核版本：${{ env.VERSION_KERNEL }}
            - 📅 编译日期：${{ env.DATE }}
            - 🖥️ 目标平台：${{ env.DEVICE_TARGET }} (${{ env.DEVICE_SUBTARGET }})
            - 📎 源码仓库：[${{ env.REPO_BRANCH }}分支](${{ env.REPO_URL }}/tree/${{ env.REPO_BRANCH }})
            
            ### 🔧 默认配置
            - 🌐 管理地址：192.168.1.1
            - 🔑 管理员密码：password
            - 📦 包含软件包：$(zcat ${{ env.FIRMWARE_PATH }}/Packages.tar.gz | grep Package: | wc -l)个
            
            ### 📋 版本记录
            ${{ env.VERSION_INFO }}

            > 校验信息：$(sha256sum ${{ env.FIRMWARE_PATH }}/*.bin | awk '{print $1}')
