name: IPQ60XX-6.12-NOWIFI

on:
  workflow_dispatch:
  schedule:
    - cron: 0 19 * * *

env:
  REPO_URL: https://github.com/LiBwrt/openwrt-6.x.git
  REPO_BRANCH: kernel-6.12
  CONFIG_FILE: configs/ipq60xx-6.12-nowifi.config
  DIY_SCRIPT: diy-script.sh
  WRT_VER: kernel-6.12
  WRT_DATE: ${{ github.run_number }}
  CACHE_TOOLCHAIN: true
  UPLOAD_BIN_DIR: false
  FIRMWARE_RELEASE: true
  WRT_TARGET: IPQ60XX-6.12-NoWifi
  TZ: Asia/Shanghai

jobs:
  Build:
    runs-on: ubuntu-22.04

    steps:
    - name: Check Server Performance(检查服务器性能)
      run: |
        echo "警告⚠ 服务器性能有限，若选择的插件过多，务必注意CPU性能！"
        echo "--------------------------CPU信息--------------------------"
        echo "CPU核心信息：$(grep 'model name' /proc/cpuinfo | sort | uniq -c)"
        echo "--------------------------内存信息--------------------------"
        free -h
        echo "--------------------------硬盘信息--------------------------"
        df -hT

    - name: Initialization Environment(初始化环境)
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo apt-get update
        sudo apt-get install -y $(curl -fsSL is.gd/depends_ubuntu_2204)
        sudo timedatectl set-timezone "$TZ"

    - name: Combine Disks(合并磁盘)
      uses: easimon/maximize-build-space@master
      with:
        swap-size-mb: 1024
        temp-reserve-mb: 100
        root-reserve-mb: 1024

    - name: Checkout
      uses: actions/checkout@main

    - name: Clone Source Code(克隆源代码)
      run: |
        git clone --depth 1 -b $REPO_BRANCH $REPO_URL openwrt
        cd openwrt
        echo "OPENWRT_PATH=$PWD" >> $GITHUB_ENV
        VERSION_KERNEL=$(grep -oP 'LINUX_KERNEL_HASH-\K[0-9]+\.[0-9]+\.[0-9]+' include/kernel-6.12)
        echo "VERSION_KERNEL=$VERSION_KERNEL" >> $GITHUB_ENV

    - name: Generate Variables(生成变量)
      run: |
        if [ ! -f "$CONFIG_FILE" ]; then
          echo "Error: Configuration file $CONFIG_FILE not found!"
          exit 1
        fi
        cp "$CONFIG_FILE" "$OPENWRT_PATH/.config"
        cd $OPENWRT_PATH
        make defconfig

    - name: Download DL Package(下载DL软件包)
      run: |
        cd $OPENWRT_PATH
        make defconfig
        small_files=$(find dl -size -1024c)
        if [ -n "$small_files" ]; then
          echo "Found small files in dl directory, removing them..."
          find dl -size -1024c -exec rm -vf {} +
        else
          echo "No small files found in dl directory."
        fi
        make download -j8 || make download -j1

    - name: Compile Firmware(开始编译固件)
      id: compile
      run: |
        cd $OPENWRT_PATH
        MAX_THREADS=$(nproc --all)
        THREADS=$((MAX_THREADS < 4 ? 4 : MAX_THREADS))  # 限制最大线程数为4
        make -j$THREADS || { echo "⚠️ 编译失败，尝试单线程编译获取详细日志..."; make -j1 V=s; }
        echo "status=success" >> $GITHUB_OUTPUT
        echo "DATE=$(date +"%Y-%m-%d_%H-%M-%S")" >> $GITHUB_ENV

    - name: Upload Bin Directory(上传固件)
      if: ${{ steps.compile.outputs.status == 'success' && env.UPLOAD_BIN_DIR == 'true' }}
      uses: actions/upload-artifact@main
      with:
        name: ${{ env.WRT_TARGET }}-bin
        path: ${{ env.OPENWRT_PATH }}/bin

    - name: Release Firmware
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ env.WRT_TARGET }}_${{ env.WRT_VER }}_${{ env.WRT_DATE }}
        files: ./wrt/upload/*.*
        body: |
          **This is OpenWrt Firmware for ${{ env.WRT_TARGET }}-${{ env.WRT_VER }}-${{ env.WRT_DATE }}**
          ### 📒 固件信息(无WIFI)
          - 无WIFI带有线NSS的6.12内核固件
          - 💻 这是 ${{ env.WRT_TARGET }}-${{ env.WRT_VER }}-${{ env.WRT_DATE }} 平台使用的 OpenWrt 固件
          - ⚽ 固件源码: ${{ env.REPO_URL }}
          - 💝 源码分支: ${{ env.REPO_BRANCH }}
          - 🌐 默认地址: 192.168.1.1
          - 🔑 默认密码: password
          ### 🧊 固件版本
          - 固件内核版本：${{ env.VERSION_KERNEL }}
          - 固件编译前最后一次➦[主源码](${{ env.REPO_URL }})更新记录
          - ${{ env.VERSION_INFO }}
