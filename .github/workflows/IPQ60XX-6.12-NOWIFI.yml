name: IPQ60XX-6.12-NOWIFI

on:
  workflow_dispatch:
  schedule:
    - cron: "0 18 * * *"  # UTCæ—¶é—´18:00ï¼ˆåŒ—äº¬æ—¶é—´å‡Œæ™¨2ç‚¹ï¼‰

jobs:
  Build:
    runs-on: ubuntu-22.04
    env:
      REPO_URL: https://github.com/LiBwrt/openwrt-6.x.git
      REPO_BRANCH: kernel-6.12
      CONFIG_FILE: configs/ipq60xx-6.12-nowifi.config
      DIY_SCRIPT: diy-script.sh
      CLASH_KERNEL: amd64
      CACHE_TOOLCHAIN: true
      UPLOAD_BIN_DIR: false
      FIRMWARE_RELEASE: true
      FIRMWARE_TAG: IPQ60XX-6.12-NOWIFI
      TZ: Asia/Shanghai

    steps:
      - name: Check Server Performance(æ£€æŸ¥æœåŠ¡å™¨æ€§èƒ½)
        run: |
          echo "è­¦å‘Šâš "
          echo "åˆ†é…çš„æœåŠ¡å™¨æ€§èƒ½æœ‰é™ï¼Œè‹¥é€‰æ‹©çš„æ’ä»¶è¿‡å¤šï¼ŒåŠ¡å¿…æ³¨æ„CPUæ€§èƒ½ï¼"
          echo -e "å·²çŸ¥CPUå‹å·ï¼ˆé™åºï¼‰ï¼š7763ï¼Œ8370Cï¼Œ8272CLï¼Œ8171Mï¼ŒE5-2673 \n"
          echo "--------------------------CPUä¿¡æ¯--------------------------"
          echo "CPUç‰©ç†æ•°é‡ï¼š$(grep "physical id" /proc/cpuinfo | sort -u | wc -l)"
          echo -e "CPUæ ¸å¿ƒä¿¡æ¯ï¼š$(grep -m1 "model name" /proc/cpuinfo | cut -d: -f2 | sed 's/^ //') \n"
          echo "--------------------------å†…å­˜ä¿¡æ¯--------------------------"
          echo "å†…å­˜æ€»é‡ï¼š$(free -h | awk '/Mem/{print $2}')"
          echo "--------------------------ç¡¬ç›˜ä¿¡æ¯--------------------------"
          df -hT

      - name: Initialization Environment(åˆå§‹åŒ–ç¯å¢ƒ)
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo rm -rf /usr/share/dotnet /etc/apt/sources.list.d/* /usr/local/lib/android || true
          sudo apt-get -qq update
          sudo apt-get -qq install $(curl -fsSL https://is.gd/depends_ubuntu_2204)
          sudo timedatectl set-timezone "$TZ"
          echo "::group::æ¸…ç†åç£ç›˜ç©ºé—´"
          df -h
          echo "::endgroup::"

      - name: Combine Disks(åˆå¹¶ç£ç›˜)
        uses: easimon/maximize-build-space@master
        with:
          swap-size-mb: 1024
          temp-reserve-mb: 100

      - name: Checkout
        uses: actions/checkout@v4

      - name: Clone Source Code(å…‹éš†æºä»£ç )
        env:
          REPO_BRANCH: ${{ env.REPO_BRANCH }}
          REPO_URL: ${{ env.REPO_URL }}
        run: |
          echo "::group::â–¼â–¼â–¼â–¼â–¼ ç¯å¢ƒéªŒè¯ â–¼â–¼â–¼â–¼â–¼"
          echo "å·¥ä½œåŒºè·¯å¾„: $GITHUB_WORKSPACE"
          echo "REPO_BRANCH: '$REPO_BRANCH'"
          echo "REPO_URL: '$REPO_URL'"
          echo "::endgroup::"

          # å¼ºåˆ¶å˜é‡æ£€æŸ¥
          if [ -z "$REPO_BRANCH" ]; then
            echo "::error::REPO_BRANCH æœªå®šä¹‰ï¼å½“å‰ç¯å¢ƒå˜é‡ï¼š"
            printenv | grep -E 'REPO_|GITHUB'
            exit 1
          fi

          echo "::group::â–¼â–¼â–¼â–¼â–¼ è¿œç¨‹åˆ†æ”¯éªŒè¯ â–¼â–¼â–¼â–¼â–¼"
          if ! git ls-remote --exit-code --heads "$REPO_URL" "$REPO_BRANCH"; then
            echo "::error::åˆ†æ”¯ $REPO_BRANCH ä¸å­˜åœ¨ï¼å¯ç”¨åˆ†æ”¯åˆ—è¡¨ï¼š"
            git ls-remote --heads "$REPO_URL" | awk -F'/' '{print $NF}'
            exit 1
          fi
          echo "::endgroup::"

          echo "::group::â–¼â–¼â–¼â–¼â–¼ å…‹éš†æ“ä½œ â–¼â–¼â–¼â–¼â–¼"
          set -x
          git clone --progress --depth 1 -b "${REPO_BRANCH}" "${REPO_URL}" openwrt
          clone_exit=$?
          set +x
          if [ $clone_exit -ne 0 ]; then
            echo "::error::å…‹éš†å¤±è´¥ï¼Exit Code: $clone_exit"
            echo "è°ƒè¯•ä¿¡æ¯ï¼š"
            echo "URLåè®®ï¼š$(echo "$REPO_URL" | cut -d: -f1)"
            exit 1
          fi
          echo "::endgroup::"

          echo "::group::â–¼â–¼â–¼â–¼â–¼ ä»“åº“éªŒè¯ â–¼â–¼â–¼â–¼â–¼"
          cd openwrt || exit 1
          echo "å½“å‰è·¯å¾„ï¼š$PWD"
          echo "ç›®å½•å†…å®¹ï¼š"
          ls -la
          echo "åˆ†æ”¯éªŒè¯ï¼š"
          git branch -a
          echo "::endgroup::"

          VERSION_KERNEL=$(awk -F= '/LINUX_KERNEL_HASH/{print $2}' include/kernel-6.12 | cut -d- -f1)
          echo "OPENWRT_PATH=$PWD" >> $GITHUB_ENV
          echo "VERSION_KERNEL=${VERSION_KERNEL:-unknown}" >> $GITHUB_ENV

      - name: Generate Variables(ç”Ÿæˆå˜é‡)
        run: |
          echo "::group::åº”ç”¨é…ç½®æ–‡ä»¶"
          cp -v "$CONFIG_FILE" "$OPENWRT_PATH/.config"
          cd "$OPENWRT_PATH" || exit 1
          make defconfig
          echo "::endgroup::"

          SOURCE_REPO=$(basename -s .git "$REPO_URL")
          DEVICE_TARGET=$(awk -F'"' '/CONFIG_TARGET_BOARD/{print $2}' .config)
          DEVICE_SUBTARGET=$(awk -F'"' '/CONFIG_TARGET_SUBTARGET/{print $2}' .config)

          echo "SOURCE_REPO=$SOURCE_REPO" >> $GITHUB_ENV
          echo "DEVICE_TARGET=$DEVICE_TARGET" >> $GITHUB_ENV
          echo "DEVICE_SUBTARGET=$DEVICE_SUBTARGET" >> $GITHUB_ENV

      - name: Cache Toolchain(ç¼“å­˜å·¥å…·é“¾)
        if: env.CACHE_TOOLCHAIN == 'true'
        uses: actions/cache@v3
        with:
          path: |
            ${{ env.OPENWRT_PATH }}/dl
            ${{ env.OPENWRT_PATH }}/build_dir
          key: ${{ runner.os }}-toolchain-${{ hashFiles('${{ env.OPENWRT_PATH }}/.config') }}

      - name: Install Feeds(å®‰è£…feeds)
        run: |
          cd "$OPENWRT_PATH" || exit 1
          ./scripts/feeds update -a
          ./scripts/feeds install -a

- name: Load Custom Configuration(åŠ è½½è‡ªå®šä¹‰é…ç½®)
  run: |
    # ======================
    # è‡ªå®šä¹‰æ–‡ä»¶è¿ç§»
    # ======================
    echo "::group::ğŸ“ è¿ç§»è‡ªå®šä¹‰æ–‡ä»¶ [å¼€å§‹]"
    CUSTOM_FILES_SRC="$GITHUB_WORKSPACE/files"
    CUSTOM_FILES_DEST="$OPENWRT_PATH/files"

    # éªŒè¯æºç›®å½•
    if [ -d "$CUSTOM_FILES_SRC" ]; then
      echo "âœ… æ£€æµ‹åˆ°è‡ªå®šä¹‰æ–‡ä»¶ç›®å½•"
      echo "æºç›®å½•è·¯å¾„: $CUSTOM_FILES_SRC"
      echo "ç›®å½•å†…å®¹å¤§å°: $(du -sh $CUSTOM_FILES_SRC | awk '{print $1}')"
      
      # æ˜¾ç¤ºç›®å½•ç»“æ„ï¼ˆæœ€å¤š3å±‚ï¼‰
      echo "ç›®å½•ç»“æ„é¢„è§ˆ:"
      find "$CUSTOM_FILES_SRC" -maxdepth 3 -print | sed -e 's;[^/]*/;|____;g;s;____|; |;g'

      # åˆ›å»ºç›®æ ‡ç›®å½•
      echo "åˆ›å»ºç›®æ ‡ç›®å½•: $CUSTOM_FILES_DEST"
      mkdir -p "$CUSTOM_FILES_DEST" || {
        echo "::error::æ— æ³•åˆ›å»ºç›®æ ‡ç›®å½•ï¼";
        exit 1;
      }

      # æ‰§è¡Œå¤åˆ¶å¹¶éªŒè¯
      echo "æ­£åœ¨åŒæ­¥æ–‡ä»¶..."
      rsync -av --checksum "$CUSTOM_FILES_SRC/" "$CUSTOM_FILES_DEST/" || {
        echo "::error::æ–‡ä»¶åŒæ­¥å¤±è´¥ï¼";
        exit 1;
      }

      # éªŒè¯å¤åˆ¶ç»“æœ
      echo "âœ… åŒæ­¥å®Œæˆï¼Œç›®æ ‡ç›®å½•éªŒè¯:"
      echo "ç›®æ ‡ç›®å½•å¤§å°: $(du -sh $CUSTOM_FILES_DEST | awk '{print $1}')"
      echo "æ–‡ä»¶æ•°é‡: $(find "$CUSTOM_FILES_DEST" -type f | wc -l)"
    else
      echo "âš ï¸ æœªæ‰¾åˆ°è‡ªå®šä¹‰æ–‡ä»¶ç›®å½•"
      echo "å½“å‰å·¥ä½œç›®å½•å†…å®¹ ($GITHUB_WORKSPACE):"
      ls -lAh "$GITHUB_WORKSPACE"
    fi
    echo "::endgroup::"

    # ======================
    # è‡ªå®šä¹‰è„šæœ¬æ‰§è¡Œ
    # ======================
    echo "::group::ğŸ› ï¸ æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬ [å¼€å§‹]"
    SCRIPT_PATH="$GITHUB_WORKSPACE/$DIY_SCRIPT"

    # ä¸¥æ ¼éªŒè¯è„šæœ¬å­˜åœ¨æ€§
    if [ ! -f "$SCRIPT_PATH" ]; then
      echo "::error::è‡ªå®šä¹‰è„šæœ¬ä¸å­˜åœ¨ï¼è·¯å¾„: $SCRIPT_PATH"
      echo "å¯ç”¨è„šæœ¬åˆ—è¡¨:"
      find "$GITHUB_WORKSPACE" -type f -name "*.sh"
      exit 1
    fi

    # æ˜¾ç¤ºè„šæœ¬ä¿¡æ¯
    echo "è„šæœ¬ç»å¯¹è·¯å¾„: $SCRIPT_PATH"
    echo "è„šæœ¬åŸºæœ¬ä¿¡æ¯:"
    file "$SCRIPT_PATH"
    echo "è„šæœ¬å¤§å°: $(du -h "$SCRIPT_PATH" | cut -f1)"
    echo "æœ€åä¿®æ”¹æ—¶é—´: $(date -r "$SCRIPT_PATH" "+%Y-%m-%d %H:%M:%S")"

    # è„šæœ¬å†…å®¹å®‰å…¨å®¡æŸ¥
    echo "è„šæœ¬å†…å®¹æ‘˜è¦ (é¦–å°¾5è¡Œ):"
    echo "----- å¼€å§‹ -----"
    head -n5 "$SCRIPT_PATH"
    echo "..."
    tail -n5 "$SCRIPT_PATH"
    echo "----- ç»“æŸ -----"

    # æƒé™è®¾ç½®
    echo "è®¾ç½®æ‰§è¡Œæƒé™..."
    chmod -v +x "$SCRIPT_PATH" || {
      echo "::error::æƒé™è®¾ç½®å¤±è´¥ï¼";
      exit 1;
    }

    # ç¯å¢ƒå‡†å¤‡
    echo "å½“å‰å·¥ä½œç›®å½•: $PWD"
    echo "åˆ‡æ¢åˆ°OpenWrtç›®å½•: $OPENWRT_PATH"
    cd "$OPENWRT_PATH" || {
      echo "::error::æ— æ³•è¿›å…¥OpenWrtç›®å½•ï¼";
      exit 1;
    }

    # æ‰§è¡Œå‰å¿«ç…§
    echo "æ‰§è¡Œå‰ç›®å½•çŠ¶æ€:"
    git status --short || true
    echo "ç£ç›˜ä½¿ç”¨æƒ…å†µ:"
    df -h .

    # æ‰§è¡Œè„šæœ¬ï¼ˆä¸¥æ ¼æ¨¡å¼ï¼‰
    echo "æ‰§è¡Œè„šæœ¬..."
    set -x  # å¼€å¯å‘½ä»¤å›æ˜¾
    /usr/bin/time -v bash -e "$SCRIPT_PATH"
    EXIT_CODE=$?
    set +x

    # æ‰§è¡ŒåéªŒè¯
    if [ $EXIT_CODE -ne 0 ]; then
      echo "::error::è„šæœ¬æ‰§è¡Œå¤±è´¥ï¼é€€å‡ºç : $EXIT_CODE"
      echo "æœ€å10æ¡æ—¥å¿—:"
      tail -n10 "$OPENWRT_PATH/build.log" || true
      exit $EXIT_CODE
    fi

    # æ‰§è¡Œåå¿«ç…§
    echo "âœ… è„šæœ¬æ‰§è¡ŒæˆåŠŸ"
    echo "æ‰§è¡Œåå˜æ›´ç»Ÿè®¡:"
    git diff --stat || true
    echo "ç£ç›˜ä½¿ç”¨æƒ…å†µ:"
    df -h .
    echo "::endgroup::"

    # ======================
    # æœ€ç»ˆéªŒè¯
    # ======================
    echo "::group::ğŸ” æœ€ç»ˆé…ç½®éªŒè¯"
    echo "å½“å‰é…ç½®æ–‡ä»¶: $OPENWRT_PATH/.config"
    echo "é…ç½®æ–‡ä»¶å¤§å°: $(du -h "$OPENWRT_PATH/.config" | cut -f1)"
    echo "å…³é”®é…ç½®é¡¹:"
    grep -E 'CONFIG_TARGET|CONFIG_PACKAGE' "$OPENWRT_PATH/.config" | sort
    echo "::endgroup::"
      - name: Download DL Package(ä¸‹è½½DLè½¯ä»¶åŒ…)
        run: |
          cd "$OPENWRT_PATH" || exit 1
          make -j8 download
          find dl -size -1k -delete

      - name: Compile Firmware(ç¼–è¯‘å›ºä»¶)
        timeout-minutes: 120
        run: |
          cd "$OPENWRT_PATH" || exit 1
          echo "å¯ç”¨çº¿ç¨‹æ•°ï¼š$(nproc)"
          make -j$(($(nproc)+1)) || make -j1 V=s
          echo "status=success" >> $GITHUB_OUTPUT

      - name: Upload Artifact(å‘å¸ƒæˆæœ)
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.FIRMWARE_TAG }}-${{ env.VERSION_KERNEL }}
          path: ${{ env.OPENWRT_PATH }}/bin/targets/**/*
