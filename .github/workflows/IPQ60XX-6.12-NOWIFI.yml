name: IPQ60XX-6.12-NOWIFI

on:
  workflow_dispatch:
  schedule:
    - cron: 0 19 * * *

env:
  REPO_URL: https://github.com/LiBwrt/openwrt-6.x.git
  REPO_BRANCH: kernel-6.12
  CONFIG_FILE: configs/ipq60xx-6.12-nowifi.config
  DIY_SCRIPT: diy-script.sh
  WRT_VER: kernel-6.12
  WRT_DATE: ${{ github.run_number }}
  CACHE_TOOLCHAIN: true
  UPLOAD_BIN_DIR: false
  FIRMWARE_RELEASE: true
  WRT_TARGET: IPQ60XX-6.12-NoWifi
  TZ: Asia/Shanghai

jobs:
  Build:
    runs-on: ubuntu-22.04

    steps:
    - name: Check Server Performance(æ£€æŸ¥æœåŠ¡å™¨æ€§èƒ½)
      run: |
        echo "è­¦å‘Šâš  æœåŠ¡å™¨æ€§èƒ½æœ‰é™ï¼Œè‹¥é€‰æ‹©çš„æ’ä»¶è¿‡å¤šï¼ŒåŠ¡å¿…æ³¨æ„CPUæ€§èƒ½ï¼"
        echo "--------------------------CPUä¿¡æ¯--------------------------"
        echo "CPUæ ¸å¿ƒä¿¡æ¯ï¼š$(grep 'model name' /proc/cpuinfo | sort | uniq -c)"
        echo "--------------------------å†…å­˜ä¿¡æ¯--------------------------"
        free -h
        echo "--------------------------ç¡¬ç›˜ä¿¡æ¯--------------------------"
        df -hT

    - name: Initialization Environment(åˆå§‹åŒ–ç¯å¢ƒ)
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo apt-get update
        sudo apt-get install -y $(curl -fsSL is.gd/depends_ubuntu_2204)
        sudo timedatectl set-timezone "$TZ"

    - name: Combine Disks(åˆå¹¶ç£ç›˜)
      uses: easimon/maximize-build-space@master
      with:
        swap-size-mb: 1024
        temp-reserve-mb: 100
        root-reserve-mb: 1024

    - name: Checkout
      uses: actions/checkout@main

    - name: Clone Source Code(å…‹éš†æºä»£ç )
      run: |
        git clone --depth 1 -b $REPO_BRANCH $REPO_URL openwrt
        cd openwrt
        echo "OPENWRT_PATH=$PWD" >> $GITHUB_ENV
        VERSION_KERNEL=$(grep -oP 'LINUX_KERNEL_HASH-\K[0-9]+\.[0-9]+\.[0-9]+' include/kernel-6.12)
        echo "VERSION_KERNEL=$VERSION_KERNEL" >> $GITHUB_ENV

    - name: Generate Variables(ç”Ÿæˆå˜é‡)
      run: |
        if [ ! -f "$CONFIG_FILE" ]; then
          echo "Error: Configuration file $CONFIG_FILE not found!"
          exit 1
        fi
        cp "$CONFIG_FILE" "$OPENWRT_PATH/.config"
        cd $OPENWRT_PATH
        make defconfig

    - name: Download DL Package(ä¸‹è½½DLè½¯ä»¶åŒ…)
      run: |
        cd $OPENWRT_PATH
        make defconfig
        small_files=$(find dl -size -1024c)
        if [ -n "$small_files" ]; then
          echo "Found small files in dl directory, removing them..."
          find dl -size -1024c -exec rm -vf {} +
        else
          echo "No small files found in dl directory."
        fi
        make download -j8 || make download -j1

    - name: Compile Firmware(å¼€å§‹ç¼–è¯‘å›ºä»¶)
      id: compile
      run: |
        cd $OPENWRT_PATH
        MAX_THREADS=$(nproc --all)
        THREADS=$((MAX_THREADS < 4 ? 4 : MAX_THREADS))  # é™åˆ¶æœ€å¤§çº¿ç¨‹æ•°ä¸º4
        make -j$THREADS || { echo "âš ï¸ ç¼–è¯‘å¤±è´¥ï¼Œå°è¯•å•çº¿ç¨‹ç¼–è¯‘è·å–è¯¦ç»†æ—¥å¿—..."; make -j1 V=s; }
        echo "status=success" >> $GITHUB_OUTPUT
        echo "DATE=$(date +"%Y-%m-%d_%H-%M-%S")" >> $GITHUB_ENV

    - name: Upload Bin Directory(ä¸Šä¼ å›ºä»¶)
      if: ${{ steps.compile.outputs.status == 'success' && env.UPLOAD_BIN_DIR == 'true' }}
      uses: actions/upload-artifact@main
      with:
        name: ${{ env.WRT_TARGET }}-bin
        path: ${{ env.OPENWRT_PATH }}/bin

    - name: Release Firmware
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ env.WRT_TARGET }}_${{ env.WRT_VER }}_${{ env.WRT_DATE }}
        files: ./wrt/upload/*.*
        body: |
          **This is OpenWrt Firmware for ${{ env.WRT_TARGET }}-${{ env.WRT_VER }}-${{ env.WRT_DATE }}**
          ### ğŸ“’ å›ºä»¶ä¿¡æ¯(æ— WIFI)
          - æ— WIFIå¸¦æœ‰çº¿NSSçš„6.12å†…æ ¸å›ºä»¶
          - ğŸ’» è¿™æ˜¯ ${{ env.WRT_TARGET }}-${{ env.WRT_VER }}-${{ env.WRT_DATE }} å¹³å°ä½¿ç”¨çš„ OpenWrt å›ºä»¶
          - âš½ å›ºä»¶æºç : ${{ env.REPO_URL }}
          - ğŸ’ æºç åˆ†æ”¯: ${{ env.REPO_BRANCH }}
          - ğŸŒ é»˜è®¤åœ°å€: 192.168.1.1
          - ğŸ”‘ é»˜è®¤å¯†ç : password
          ### ğŸ§Š å›ºä»¶ç‰ˆæœ¬
          - å›ºä»¶å†…æ ¸ç‰ˆæœ¬ï¼š${{ env.VERSION_KERNEL }}
          - å›ºä»¶ç¼–è¯‘å‰æœ€åä¸€æ¬¡â¦[ä¸»æºç ](${{ env.REPO_URL }})æ›´æ–°è®°å½•
          - ${{ env.VERSION_INFO }}
